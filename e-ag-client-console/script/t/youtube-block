#!/bin/bash
# ðŸ”’ Dinamik YouTube engelleme script'i (Ã§alÄ±ÅŸÄ±r ve tekrar tekrar Ã§alÄ±ÅŸtÄ±rÄ±labilir)
# IPv4 + IPv6, TCP+UDP 80/443

set -e

# Domain listesi
YOUTUBE_DOMAINS=(
    "youtube.com"
    "www.youtube.com"
    "m.youtube.com"
    "youtu.be"
    "googlevideo.com"
    "www.googlevideo.com"
)

# ipset ve iptables zincirleri
IPSET4="ytblock"
IPSET6="ytblock6"
CHAIN4="YT_BLOCK"
CHAIN6="YT_BLOCK6"

# ðŸ§¹ Eski ipset setlerini temizle
ipset destroy "$IPSET4" 2>/dev/null || true
ipset destroy "$IPSET6" 2>/dev/null || true

# ðŸŒ Yeni ipset setlerini oluÅŸtur
ipset create "$IPSET4" hash:ip 2>/dev/null || true
ipset create "$IPSET6" hash:ip family inet6 2>/dev/null || true

echo "ðŸ”Ž GÃ¼ncel YouTube IP'leri alÄ±nÄ±yor..."
for domain in "${YOUTUBE_DOMAINS[@]}"; do
    echo " â€¢ $domain"

    # IPv4
    for ip in $(dig +short A "$domain"); do
        [[ -z "$ip" ]] && continue
        ipset add "$IPSET4" "$ip" 2>/dev/null || true
        echo "   âž• IPv4 $ip eklendi"
    done

    # IPv6
    for ip6 in $(dig +short AAAA "$domain"); do
        [[ -z "$ip6" ]] && continue
        ipset add "$IPSET6" "$ip6" 2>/dev/null || true
        echo "   âž• IPv6 $ip6 eklendi"
    done
done

# ðŸ§© iptables zincirleri oluÅŸtur veya temizle
for table in 4 6; do
    if [ "$table" -eq 4 ]; then
        IPT_CMD="iptables"
        CHAIN="$CHAIN4"
        IPSET="$IPSET4"
    else
        IPT_CMD="ip6tables"
        CHAIN="$CHAIN6"
        IPSET="$IPSET6"
    fi

    if ! $IPT_CMD -L "$CHAIN" >/dev/null 2>&1; then
        $IPT_CMD -N "$CHAIN"
        $IPT_CMD -I OUTPUT -j "$CHAIN"
        $IPT_CMD -I FORWARD -j "$CHAIN"
    else
        $IPT_CMD -F "$CHAIN"
    fi

    # TCP ve UDP 80/443 blok
    $IPT_CMD -A "$CHAIN" -m set --match-set "$IPSET" dst -p tcp -m multiport --dports 80,443 -j DROP
    $IPT_CMD -A "$CHAIN" -m set --match-set "$IPSET" dst -p udp -m multiport --dports 80,443 -j DROP
done

echo "âœ… YouTube engellendi! (IPv4 + IPv6, TCP+UDP 80/443)"
