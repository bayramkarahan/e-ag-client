#!/bin/bash
# Klavye ve fareyi USB Ã¼zerinden disable/enable eden script
# Root ile Ã§alÄ±ÅŸtÄ±rÄ±lmalÄ±, kullanÄ±cÄ± X oturumunu otomatik tespit eder
# KullanÄ±m:
#   ./usb-toggle-x.sh keyboard disable
#   ./usb-toggle-x.sh mouse enable
#   ./usb-toggle-x.sh all disable

TYPE=$1   # keyboard, mouse veya all
ACTION=$2 # disable veya enable

if [[ -z "$TYPE" || -z "$ACTION" ]]; then
    echo "Usage: $0 keyboard|mouse|all disable|enable"
    exit 1
fi

VAL=0
[[ "$ACTION" == "enable" ]] && VAL=1

# Aktif kullanÄ±cÄ± ve DISPLAY tespiti
USER=$(who | grep -Eo "^[^ ]+" | head -n1)
DISPLAY=$(who | grep -Eo "\(.*\)" | head -n1 | tr -d '()')
XAUTH="/home/$USER/.Xauthority"

if [[ -z "$USER" || ! -f "$XAUTH" ]]; then
    echo "âŒ X oturumu veya XAUTHORITY bulunamadÄ±."
    exit 1
fi

echo "ðŸ”¹ KullanÄ±cÄ±: $USER"
echo "ðŸ”¹ DISPLAY: $DISPLAY"
echo "ðŸ”¹ Action: $TYPE -> $ACTION"

# USB cihazlarÄ±nÄ± disable/enable
for d in /sys/bus/usb/devices/*; do
    [[ -f "$d/authorized" ]] || continue
    name=$(cat "$d/product" 2>/dev/null)
    [[ -z "$name" ]] && continue

    case "$TYPE" in
        keyboard) [[ "$name" =~ [Kk]B|Keyboard ]] || continue ;;
        mouse)    [[ "$name" =~ [Mm]ouse|[Pp]oint|[Oo]ptical|Trackball|Touchpad ]] || continue ;;
        all)      : ;; # tÃ¼m USB cihazlar
        *) continue ;;
    esac

    # Root Ã¼zerinden yaz
    echo "$VAL" | tee "$d/authorized"
    echo "âœ… $TYPE ($name) -> $ACTION"
done

# XInput Ã¼zerinden de gerÃ§ek X oturumu iÃ§in disable/enable
sudo -u "$USER" DISPLAY=$DISPLAY XAUTHORITY=$XAUTH bash -c '
xinput list --name-only | grep -Ei "keyboard|kbd|Translated|HID|pointer|mouse|Trackball|Touchpad" | grep -viE "virtual|xtest|button" | while read -r name; do

    id=$(xinput list --id-only "$name" 2>/dev/null)
    [[ -n "$id" ]] && {
        if [[ "'"$ACTION"'" == "disable" ]]; then
            xinput disable "$id"
        else
            xinput enable "$id"
        fi
        echo "ðŸ–¥ï¸ $name (id=$id) -> '"$ACTION"'"
    fi
done
'

